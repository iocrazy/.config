#!/usr/bin/env bash
# resume-agent
# æ”¾ç½®ä½ç½®: é¡¹ç›®æ ¹ç›®å½• (å¦‚ ~/projects/my_app/)
# åŠŸèƒ½: æ¢å¤/åˆ‡æ¢åˆ°å·²å­˜åœ¨çš„ agent windowï¼Œæˆ–æ¢å¤å·²æœ‰çš„ worktree
#
# ç”¨æ³•:
#   ./resume-agent              # äº¤äº’å¼é€‰æ‹©çª—å£
#   ./resume-agent "feature-1"  # ç›´æ¥åˆ‡æ¢åˆ° feature-1 çª—å£
#
# å¦‚æœ worktree å­˜åœ¨ä½† tmux çª—å£ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨é‡æ–°åˆ›å»ºçª—å£

set -euo pipefail

WINDOW_NAME="${1:-}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="$SCRIPT_DIR"

# agents ç›®å½•
AGENTS_DIR="$PROJECT_ROOT/agents/features"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å‡½æ•°: åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ agent (tmux çª—å£ + æœªæ‰“å¼€çš„ worktree)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
list_agents() {
    echo -e "\033[1;36må¯ç”¨ Agent:\033[0m"
    echo ""

    # 1. å·²æ‰“å¼€çš„ tmux çª—å£
    echo -e "\033[1;32mğŸ“º å·²æ‰“å¼€çš„çª—å£:\033[0m"
    tmux list-windows -F '#{window_index}:#{window_name}' 2>/dev/null | while IFS=: read -r idx name; do
        PORT=$(tmux display-message -t ":$idx" -p '#{@agent_port}' 2>/dev/null || echo "")
        if [[ -n "$PORT" ]]; then
            echo "  [$idx] $name (port: $PORT) âœ…"
        else
            echo "  [$idx] $name"
        fi
    done

    # 2. æœªæ‰“å¼€çš„ worktree
    if [[ -d "$AGENTS_DIR" ]]; then
        echo ""
        echo -e "\033[1;33mğŸ“ æœªæ‰“å¼€çš„ Worktree:\033[0m"
        for dir in "$AGENTS_DIR"/*/repo; do
            if [[ -d "$dir" ]]; then
                FEATURE_NAME=$(basename "$(dirname "$dir")")
                # æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯¹åº”çš„ tmux çª—å£
                if ! tmux list-windows -F '#{window_name}' 2>/dev/null | grep -qx "$FEATURE_NAME"; then
                    echo "  [ ] $FEATURE_NAME (å¯æ¢å¤)"
                fi
            fi
        done
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å‡½æ•°: æ¢å¤ worktree ä¸ºæ–°çª—å£
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
restore_worktree() {
    local NAME="$1"
    local WORKTREE_DIR="$AGENTS_DIR/$NAME/repo"

    if [[ ! -d "$WORKTREE_DIR" ]]; then
        echo -e "\033[1;31mâŒ Worktree ä¸å­˜åœ¨: $WORKTREE_DIR\033[0m"
        return 1
    fi

    # è°ƒç”¨ start-agentï¼ˆå®ƒä¼šæ£€æµ‹åˆ° worktree å·²å­˜åœ¨ï¼Œä¸ä¼šé‡å¤åˆ›å»ºï¼‰
    "$SCRIPT_DIR/start-agent" "$NAME"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å¦‚æœæŒ‡å®šäº†çª—å£å
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [[ -n "$WINDOW_NAME" ]]; then
    # æ£€æŸ¥ tmux çª—å£æ˜¯å¦å­˜åœ¨
    if tmux list-windows -F '#{window_name}' 2>/dev/null | grep -qx "$WINDOW_NAME"; then
        tmux select-window -t "$WINDOW_NAME"
        PORT=$(tmux display-message -p '#{@agent_port}' 2>/dev/null || echo "")
        echo -e "\033[1;32mâœ… å·²åˆ‡æ¢åˆ°çª—å£: $WINDOW_NAME\033[0m"
        [[ -n "$PORT" ]] && echo -e "   ç«¯å£: $PORT"
        exit 0
    fi

    # æ£€æŸ¥ worktree æ˜¯å¦å­˜åœ¨ï¼ˆå¯ä»¥æ¢å¤ï¼‰
    WORKTREE_DIR="$AGENTS_DIR/$WINDOW_NAME/repo"
    if [[ -d "$WORKTREE_DIR" ]]; then
        echo -e "\033[1;33mğŸ“ Worktree å­˜åœ¨ä½†çª—å£æœªæ‰“å¼€ï¼Œæ­£åœ¨æ¢å¤...\033[0m"
        restore_worktree "$WINDOW_NAME"
        exit 0
    fi

    echo -e "\033[1;31mâŒ '$WINDOW_NAME' ä¸å­˜åœ¨\033[0m"
    echo ""
    list_agents
    exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# äº¤äº’å¼é€‰æ‹©çª—å£ (ä½¿ç”¨ fzf æˆ–ç®€å•åˆ—è¡¨)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# æ£€æŸ¥æ˜¯å¦æœ‰ fzf
if command -v fzf &>/dev/null; then
    # æ„å»ºé€‰é¡¹åˆ—è¡¨
    OPTIONS=""

    # æ·»åŠ å·²æ‰“å¼€çš„çª—å£
    while IFS=: read -r idx name; do
        PORT=$(tmux display-message -t ":$idx" -p '#{@agent_port}' 2>/dev/null || echo "")
        if [[ -n "$PORT" ]]; then
            OPTIONS+="[çª—å£] $name (port: $PORT)"$'\n'
        else
            OPTIONS+="[çª—å£] $name"$'\n'
        fi
    done < <(tmux list-windows -F '#{window_index}:#{window_name}' 2>/dev/null)

    # æ·»åŠ æœªæ‰“å¼€çš„ worktree
    if [[ -d "$AGENTS_DIR" ]]; then
        for dir in "$AGENTS_DIR"/*/repo; do
            if [[ -d "$dir" ]]; then
                FEATURE_NAME=$(basename "$(dirname "$dir")")
                if ! tmux list-windows -F '#{window_name}' 2>/dev/null | grep -qx "$FEATURE_NAME"; then
                    OPTIONS+="[æ¢å¤] $FEATURE_NAME"$'\n'
                fi
            fi
        done
    fi

    SELECTED=$(echo -e "$OPTIONS" | grep -v '^$' | fzf --prompt="é€‰æ‹© Agent > " --height=15 --reverse)

    if [[ -n "$SELECTED" ]]; then
        # è§£æé€‰æ‹©
        if [[ "$SELECTED" == "[çª—å£]"* ]]; then
            NAME=$(echo "$SELECTED" | sed 's/\[çª—å£\] //' | cut -d' ' -f1)
            tmux select-window -t "$NAME"
            echo -e "\033[1;32mâœ… å·²åˆ‡æ¢åˆ°çª—å£: $NAME\033[0m"
        elif [[ "$SELECTED" == "[æ¢å¤]"* ]]; then
            NAME=$(echo "$SELECTED" | sed 's/\[æ¢å¤\] //')
            restore_worktree "$NAME"
        fi
    fi
else
    list_agents
    echo ""
    read -p "è¾“å…¥çª—å£åæˆ–ç´¢å¼•: " INPUT

    if [[ -n "$INPUT" ]]; then
        # å°è¯•ä½œä¸ºç´¢å¼•
        if tmux select-window -t "$INPUT" 2>/dev/null; then
            WINDOW_NAME=$(tmux display-message -p '#{window_name}')
            echo -e "\033[1;32mâœ… å·²åˆ‡æ¢åˆ°çª—å£: $WINDOW_NAME\033[0m"
        # å°è¯•ä½œä¸ºåç§°
        elif tmux list-windows -F '#{window_name}' 2>/dev/null | grep -qx "$INPUT"; then
            tmux select-window -t "$INPUT"
            echo -e "\033[1;32mâœ… å·²åˆ‡æ¢åˆ°çª—å£: $INPUT\033[0m"
        # å°è¯•æ¢å¤ worktree
        elif [[ -d "$AGENTS_DIR/$INPUT/repo" ]]; then
            restore_worktree "$INPUT"
        else
            echo -e "\033[1;31mâŒ æ— æ•ˆè¾“å…¥: $INPUT\033[0m"
        fi
    fi
fi
