#!/usr/bin/env bash
# start-agent
# æ”¾ç½®ä½ç½®: é¡¹ç›®æ ¹ç›®å½•
# åŠŸèƒ½: ä½¿ç”¨ Git Worktree åˆ›å»ºç‹¬ç«‹å·¥ä½œç›®å½•ï¼Œå¯åŠ¨ agent window
#
# ç”¨æ³•:
#   ./start-agent "feature-1"    # åˆ›å»º feature-1 worktree å’Œçª—å£
#   ./start-agent "fix-bug"      # åˆ›å»º fix-bug worktree å’Œçª—å£
#
# é…ç½®æ–¹å¼ (æŒ‰ä¼˜å…ˆçº§):
#   1. é¡¹ç›®æ ¹ç›®å½•çš„ .agent-config æ–‡ä»¶
#   2. è„šæœ¬å†…çš„é»˜è®¤é…ç½®
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é»˜è®¤é…ç½® (å¯è¢« .agent-config è¦†ç›–)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# --- å•æœåŠ¡æ¨¡å¼ (é»˜è®¤) ---
PORT_BASE=9100
DEV_SERVER_CMD=""
BROWSER="chrome"
AUTO_OPEN_BROWSER=true
BASE_BRANCH="main"

# --- å…¨æ ˆæ¨¡å¼ (FULLSTACK_MODE=true æ—¶å¯ç”¨) ---
FULLSTACK_MODE=false
FRONTEND_DIR="frontend"
FRONTEND_PORT_BASE=3000
FRONTEND_CMD=""
BACKEND_DIR="backend"
BACKEND_PORT_BASE=8000
BACKEND_CMD=""

# --- .env ç«¯å£åŒæ­¥ (å¯é€‰) ---
BACKEND_ENV_FILE=""        # å¦‚ ".env"
BACKEND_PORT_VAR=""        # å¦‚ "APP_PORT"
FRONTEND_ENV_FILE=""       # å¦‚ ".env"
FRONTEND_API_VAR=""        # å¦‚ "VITE_API_URL"
FRONTEND_API_FORMAT=""     # å¦‚ "http://localhost:\$BACKEND_PORT"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¾…åŠ©å‡½æ•°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# æ›´æ–° .env æ–‡ä»¶ä¸­çš„å˜é‡
update_env_var() {
    local ENV_FILE="$1"
    local VAR_NAME="$2"
    local VAR_VALUE="$3"

    if [[ ! -f "$ENV_FILE" ]]; then
        echo "$VAR_NAME=$VAR_VALUE" > "$ENV_FILE"
        return
    fi

    if grep -q "^${VAR_NAME}=" "$ENV_FILE"; then
        # å˜é‡å­˜åœ¨ï¼Œæ›´æ–°å®ƒ (macOS å…¼å®¹)
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s|^${VAR_NAME}=.*|${VAR_NAME}=${VAR_VALUE}|" "$ENV_FILE"
        else
            sed -i "s|^${VAR_NAME}=.*|${VAR_NAME}=${VAR_VALUE}|" "$ENV_FILE"
        fi
    else
        # å˜é‡ä¸å­˜åœ¨ï¼Œè¿½åŠ 
        echo "$VAR_NAME=$VAR_VALUE" >> "$ENV_FILE"
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è„šæœ¬é€»è¾‘
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -euo pipefail

WINDOW_NAME="${1:-agent}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR"
PROJECT_NAME="$(basename "$PROJECT_ROOT")"

# åŠ è½½é¡¹ç›®é…ç½®æ–‡ä»¶ (å¦‚æžœå­˜åœ¨)
# æ”¯æŒ: .agent-config æˆ– *.agent-config (å¦‚ react.agent-config)
AGENT_CONFIG_FILE=""
if [[ -f "$PROJECT_ROOT/.agent-config" ]]; then
    AGENT_CONFIG_FILE="$PROJECT_ROOT/.agent-config"
else
    # æŸ¥æ‰¾ *.agent-config æ–‡ä»¶ (å–ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„)
    for f in "$PROJECT_ROOT"/*.agent-config; do
        if [[ -f "$f" ]]; then
            AGENT_CONFIG_FILE="$f"
            break
        fi
    done
fi

if [[ -n "$AGENT_CONFIG_FILE" ]]; then
    source "$AGENT_CONFIG_FILE"
    echo -e "\033[1;34mðŸ“‹ å·²åŠ è½½é…ç½®: $(basename "$AGENT_CONFIG_FILE")\033[0m"
fi

AGENTS_DIR="$PROJECT_ROOT/agents/features"
WORKTREE_DIR="$AGENTS_DIR/$WINDOW_NAME/repo"

# æ£€æŸ¥çª—å£æ˜¯å¦å·²å­˜åœ¨
if tmux list-windows -F '#{window_name}' 2>/dev/null | grep -qx "$WINDOW_NAME"; then
    echo -e "\033[1;33mâš ï¸  çª—å£ '$WINDOW_NAME' å·²å­˜åœ¨ï¼Œåˆ‡æ¢åˆ°è¯¥çª—å£\033[0m"
    tmux select-window -t "$WINDOW_NAME"
    exit 0
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Git Worktree: åˆ›å»ºç‹¬ç«‹å·¥ä½œç›®å½•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [[ -d "$WORKTREE_DIR" ]]; then
    echo -e "\033[1;33mðŸ“ Worktree å·²å­˜åœ¨: $WORKTREE_DIR\033[0m"
else
    echo -e "\033[1;34mðŸ“ åˆ›å»º Worktree: $WORKTREE_DIR\033[0m"
    mkdir -p "$AGENTS_DIR/$WINDOW_NAME"

    if git -C "$PROJECT_ROOT" show-ref --verify --quiet "refs/heads/$WINDOW_NAME" 2>/dev/null; then
        git -C "$PROJECT_ROOT" worktree add "$WORKTREE_DIR" "$WINDOW_NAME"
    else
        git -C "$PROJECT_ROOT" worktree add -b "$WINDOW_NAME" "$WORKTREE_DIR" "$BASE_BRANCH"
    fi
    echo -e "\033[1;32mâœ… åˆ›å»ºåˆ†æ”¯: $WINDOW_NAME (from $BASE_BRANCH)\033[0m"

    # å¤åˆ¶ destroy.sh åˆ° feature ç›®å½•
    [[ -f "$PROJECT_ROOT/destroy.sh" ]] && cp "$PROJECT_ROOT/destroy.sh" "$AGENTS_DIR/$WINDOW_NAME/" && chmod +x "$AGENTS_DIR/$WINDOW_NAME/destroy.sh"

    # å¤åˆ¶ on-tmux-window-activate.sh åˆ° feature ç›®å½• (å¯é€‰)
    [[ -f "$PROJECT_ROOT/on-tmux-window-activate.sh" ]] && cp "$PROJECT_ROOT/on-tmux-window-activate.sh" "$AGENTS_DIR/$WINDOW_NAME/" && chmod +x "$AGENTS_DIR/$WINDOW_NAME/on-tmux-window-activate.sh"
fi

# åˆ›å»ºæ–°çª—å£
tmux new-window -n "$WINDOW_NAME" -c "$WORKTREE_DIR"

# èŽ·å–çª—å£ç´¢å¼• (çª—å£åˆ›å»ºåŽæ‰èƒ½èŽ·å–å‡†ç¡®å€¼)
WINDOW_INDEX=$(tmux display-message -p '#{window_index}')

# ç”Ÿæˆ feature.json é…ç½®æ–‡ä»¶ (ç±»ä¼¼åšä¸»çš„è®¾è®¡)
FEATURE_CONFIG="$AGENTS_DIR/$WINDOW_NAME/feature.json"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å…¨æ ˆæ¨¡å¼: 4 pane å¸ƒå±€
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                        â”‚      lazygit         â”‚
# â”‚       ä¸»ç»ˆç«¯           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚      (pane 0)          â”‚  frontend dev server â”‚
# â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                        â”‚  backend dev server  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [[ "$FULLSTACK_MODE" == "true" ]]; then
    FRONTEND_PORT=$((FRONTEND_PORT_BASE + WINDOW_INDEX))
    BACKEND_PORT=$((BACKEND_PORT_BASE + WINDOW_INDEX))

    FRONTEND_WORK_DIR="$WORKTREE_DIR/$FRONTEND_DIR"
    BACKEND_WORK_DIR="$WORKTREE_DIR/$BACKEND_DIR"

    # ç”Ÿæˆ feature.json
    cat > "$FEATURE_CONFIG" << EOF
{
  "name": "$WINDOW_NAME",
  "worktree": "$WORKTREE_DIR",
  "branch": "$WINDOW_NAME",
  "base_branch": "$BASE_BRANCH",
  "fullstack": true,
  "frontend_port": $FRONTEND_PORT,
  "backend_port": $BACKEND_PORT,
  "browser": "$BROWSER"
}
EOF

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # åŒæ­¥ .env ç«¯å£é…ç½®
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # æ›´æ–°åŽç«¯ .env (å¦‚ APP_PORT=8001)
    if [[ -n "$BACKEND_ENV_FILE" && -n "$BACKEND_PORT_VAR" ]]; then
        BACKEND_ENV_PATH="$BACKEND_WORK_DIR/$BACKEND_ENV_FILE"
        update_env_var "$BACKEND_ENV_PATH" "$BACKEND_PORT_VAR" "$BACKEND_PORT"
        echo -e "\033[1;34mðŸ”§ æ›´æ–°åŽç«¯ .env: $BACKEND_PORT_VAR=$BACKEND_PORT\033[0m"
    fi

    # æ›´æ–°å‰ç«¯ .env (å¦‚ VITE_API_URL=http://localhost:8001)
    if [[ -n "$FRONTEND_ENV_FILE" && -n "$FRONTEND_API_VAR" && -n "$FRONTEND_API_FORMAT" ]]; then
        FRONTEND_ENV_PATH="$FRONTEND_WORK_DIR/$FRONTEND_ENV_FILE"
        API_URL="${FRONTEND_API_FORMAT//\$BACKEND_PORT/$BACKEND_PORT}"
        update_env_var "$FRONTEND_ENV_PATH" "$FRONTEND_API_VAR" "$API_URL"
        echo -e "\033[1;34mðŸ”§ æ›´æ–°å‰ç«¯ .env: $FRONTEND_API_VAR=$API_URL\033[0m"
    fi

    # ä¿å­˜åˆ° tmux window options
    tmux set-option -w @agent_frontend_port "$FRONTEND_PORT"
    tmux set-option -w @agent_backend_port "$BACKEND_PORT"
    tmux set-option -w @agent_dir "$WORKTREE_DIR"
    tmux set-option -w @agent_main_repo "$PROJECT_ROOT"
    tmux set-option -w @agent_browser "$BROWSER"
    tmux set-option -w @agent_name "$WINDOW_NAME"
    tmux set-option -w @agent_fullstack "true"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # åˆ›å»º 4 pane å¸ƒå±€:
    # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    # â”‚                        â”‚      lazygit         â”‚
    # â”‚       ä¸»ç»ˆç«¯           â”‚      (pane 1)        â”‚
    # â”‚      (pane 0)          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    # â”‚                        â”‚  frontend server     â”‚
    # â”‚                        â”‚      (pane 2)        â”‚
    # â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    # â”‚                        â”‚  backend server      â”‚
    # â”‚                        â”‚      (pane 3)        â”‚
    # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # æ­¥éª¤1: æ°´å¹³åˆ†å‰²
    tmux split-window -h -p 45 -c "$WORKTREE_DIR"
    # pane 0 = å·¦è¾¹, pane 1 = å³è¾¹ (ç„¦ç‚¹åœ¨ pane 1)

    # æ­¥éª¤2: åœ¨å³è¾¹åž‚ç›´åˆ†å‰²ä¸¤æ¬¡
    tmux split-window -v -p 66 -c "$WORKTREE_DIR"
    tmux split-window -v -p 50 -c "$WORKTREE_DIR"
    # pane 0 = å·¦è¾¹, pane 1 = å³ä¸Š, pane 2 = å³ä¸­, pane 3 = å³ä¸‹

    # åœ¨å³ä¸Šå¯åŠ¨ lazygit (ä½¿ç”¨ pane ID è€Œä¸æ˜¯ç¼–å·)
    tmux send-keys -t "{top-right}" "lazygit" Enter

    # åœ¨å³ä¸­å¯åŠ¨ frontend server
    if [[ -n "$FRONTEND_CMD" ]]; then
        CMD="${FRONTEND_CMD//\$PORT/$FRONTEND_PORT}"
        # å³ä¸­æ˜¯é™¤äº† top-right å’Œ bottom-right ä¹‹å¤–çš„å³è¾¹ pane
        tmux send-keys -t :.2 "cd '$FRONTEND_WORK_DIR' && $CMD" Enter
    fi

    # åœ¨å³ä¸‹å¯åŠ¨ backend server
    if [[ -n "$BACKEND_CMD" ]]; then
        CMD="${BACKEND_CMD//\$PORT/$BACKEND_PORT}"
        tmux send-keys -t "{bottom-right}" "cd '$BACKEND_WORK_DIR' && $CMD" Enter
    fi

    # åœ¨å·¦è¾¹ä¸»ç»ˆç«¯æ˜¾ç¤ºä¿¡æ¯ - å†™å…¥ä¸´æ—¶æ–‡ä»¶å†æ˜¾ç¤º
    INFO_FILE="$AGENTS_DIR/$WINDOW_NAME/.agent-info"
    cat > "$INFO_FILE" << EOF

Host path: $WORKTREE_DIR
Created branch: $WINDOW_NAME (from $BASE_BRANCH)
Frontend: http://localhost:$FRONTEND_PORT ($FRONTEND_DIR)
Backend: http://localhost:$BACKEND_PORT ($BACKEND_DIR)
Config: $FEATURE_CONFIG

EOF
    tmux send-keys -t "{left}" "clear && cat '$INFO_FILE'" Enter

    # è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ (å‰ç«¯)
    if [[ "$AUTO_OPEN_BROWSER" == "true" && -n "$BROWSER" && -n "$FRONTEND_CMD" ]]; then
        (
            sleep 3
            URL="http://localhost:$FRONTEND_PORT"
            case "$BROWSER" in
                chrome|"Google Chrome")
                    osascript -e "tell application \"Google Chrome\" to open location \"$URL\"" 2>/dev/null || true
                    ;;
                safari|Safari)
                    osascript -e "tell application \"Safari\" to open location \"$URL\"" 2>/dev/null || true
                    ;;
                *)
                    open "$URL" 2>/dev/null || true
                    ;;
            esac
        ) &
    fi

    # ç„¦ç‚¹å›žåˆ°å·¦è¾¹ä¸»ç»ˆç«¯
    tmux select-pane -t "{left}"

    # å‘ agent-tracker æ³¨å†Œä»»åŠ¡
    TRACKER_CLIENT="${TRACKER_CLIENT:-$HOME/.config/agent-tracker/bin/tracker-client}"
    if [[ -x "$TRACKER_CLIENT" ]] || command -v tracker-client &>/dev/null; then
        [[ -x "$TRACKER_CLIENT" ]] || TRACKER_CLIENT="tracker-client"
        SESSION_NAME=$(tmux display-message -p '#{session_name}')
        SESSION_ID=$(tmux display-message -p '#{session_id}')
        WINDOW_ID=$(tmux display-message -p '#{window_id}')
        PANE_ID=$(tmux display-message -p '#{pane_id}')
        if "$TRACKER_CLIENT" command start_task \
            -session "$SESSION_NAME" \
            -session-id "$SESSION_ID" \
            -window "$WINDOW_NAME" \
            -window-id "$WINDOW_ID" \
            -pane "$PANE_ID" \
            -summary "Agent: $WINDOW_NAME (fullstack F:$FRONTEND_PORT B:$BACKEND_PORT)" 2>/dev/null; then
            echo -e "\033[1;32mðŸ“‹ Task registered to agent-tracker\033[0m"
        fi
    fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å•æœåŠ¡æ¨¡å¼: 3 pane å¸ƒå±€ (é»˜è®¤)
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                        â”‚      lazygit         â”‚
# â”‚       ä¸»ç»ˆç«¯           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚      (pane 0)          â”‚    dev server        â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

else
    PORT=$((PORT_BASE + WINDOW_INDEX))

    # ç”Ÿæˆ feature.json
    cat > "$FEATURE_CONFIG" << EOF
{
  "name": "$WINDOW_NAME",
  "worktree": "$WORKTREE_DIR",
  "branch": "$WINDOW_NAME",
  "base_branch": "$BASE_BRANCH",
  "fullstack": false,
  "port": $PORT,
  "browser": "$BROWSER"
}
EOF

    # ä¿å­˜åˆ° tmux window options
    tmux set-option -w @agent_port "$PORT"
    tmux set-option -w @agent_dir "$WORKTREE_DIR"
    tmux set-option -w @agent_main_repo "$PROJECT_ROOT"
    tmux set-option -w @agent_browser "$BROWSER"
    tmux set-option -w @agent_name "$WINDOW_NAME"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # åˆ›å»º 3 pane å¸ƒå±€:
    # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    # â”‚                        â”‚      lazygit         â”‚
    # â”‚       ä¸»ç»ˆç«¯           â”‚      (pane 1)        â”‚
    # â”‚      (pane 0)          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    # â”‚                        â”‚    dev server        â”‚
    # â”‚                        â”‚      (pane 2)        â”‚
    # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # æ­¥éª¤1: æ°´å¹³åˆ†å‰² - å½“å‰ pane åœ¨å·¦è¾¹ä¿æŒï¼Œæ–° pane åœ¨å³è¾¹
    # -h = horizontal split (å·¦å³åˆ†å‰²)
    # -p 45 = æ–° pane å  45%
    tmux split-window -h -p 45 -c "$WORKTREE_DIR"
    # çŽ°åœ¨: pane 0 = å·¦è¾¹, pane 1 = å³è¾¹ (ç„¦ç‚¹åœ¨ pane 1)

    # æ­¥éª¤2: åœ¨å³è¾¹ pane (å½“å‰ç„¦ç‚¹) åž‚ç›´åˆ†å‰²
    # -v = vertical split (ä¸Šä¸‹åˆ†å‰²)
    # -p 35 = æ–° pane (ä¸‹é¢) å  35%
    tmux split-window -v -p 35 -c "$WORKTREE_DIR"
    # çŽ°åœ¨: pane 0 = å·¦è¾¹, pane 1 = å³ä¸Š, pane 2 = å³ä¸‹ (ç„¦ç‚¹åœ¨ pane 2)

    # è°ƒè¯•: æ‰“å° pane ä¿¡æ¯
    # tmux display-panes -d 2000

    # åœ¨ pane 1 (å³ä¸Š) å¯åŠ¨ lazygit
    tmux send-keys -t "{top-right}" "lazygit" Enter

    # åœ¨ pane 2 (å³ä¸‹) å¯åŠ¨ dev server
    if [[ -n "$DEV_SERVER_CMD" ]]; then
        CMD="${DEV_SERVER_CMD//\$PORT/$PORT}"
        tmux send-keys -t "{bottom-right}" "$CMD" Enter
    fi

    # åœ¨ pane 0 (å·¦è¾¹) æ˜¾ç¤ºä¿¡æ¯ - å†™å…¥ä¸´æ—¶æ–‡ä»¶å†æ˜¾ç¤º
    INFO_FILE="$AGENTS_DIR/$WINDOW_NAME/.agent-info"
    cat > "$INFO_FILE" << EOF

Host path: $WORKTREE_DIR
Created branch: $WINDOW_NAME (from $BASE_BRANCH)
URL: http://localhost:$PORT
Config: $FEATURE_CONFIG

EOF
    tmux send-keys -t "{left}" "clear && cat '$INFO_FILE'" Enter

    # è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
    if [[ "$AUTO_OPEN_BROWSER" == "true" && -n "$BROWSER" && -n "$DEV_SERVER_CMD" ]]; then
        (
            sleep 3
            URL="http://localhost:$PORT"
            case "$BROWSER" in
                chrome|"Google Chrome")
                    osascript -e "tell application \"Google Chrome\" to open location \"$URL\"" 2>/dev/null || true
                    ;;
                safari|Safari)
                    osascript -e "tell application \"Safari\" to open location \"$URL\"" 2>/dev/null || true
                    ;;
                *)
                    open "$URL" 2>/dev/null || true
                    ;;
            esac
        ) &
    fi

    # ç„¦ç‚¹å›žåˆ°å·¦è¾¹ä¸»ç»ˆç«¯
    tmux select-pane -t "{left}"

    # å‘ agent-tracker æ³¨å†Œä»»åŠ¡
    TRACKER_CLIENT="${TRACKER_CLIENT:-$HOME/.config/agent-tracker/bin/tracker-client}"
    if [[ -x "$TRACKER_CLIENT" ]] || command -v tracker-client &>/dev/null; then
        [[ -x "$TRACKER_CLIENT" ]] || TRACKER_CLIENT="tracker-client"
        SESSION_NAME=$(tmux display-message -p '#{session_name}')
        SESSION_ID=$(tmux display-message -p '#{session_id}')
        WINDOW_ID=$(tmux display-message -p '#{window_id}')
        PANE_ID=$(tmux display-message -p '#{pane_id}')
        if "$TRACKER_CLIENT" command start_task \
            -session "$SESSION_NAME" \
            -session-id "$SESSION_ID" \
            -window "$WINDOW_NAME" \
            -window-id "$WINDOW_ID" \
            -pane "$PANE_ID" \
            -summary "Agent: $WINDOW_NAME (port $PORT)" 2>/dev/null; then
            echo -e "\033[1;32mðŸ“‹ Task registered to agent-tracker\033[0m"
        fi
    fi
fi
