#!/usr/bin/env bash
# start-workspace
# 功能: 在当前目录创建完整开发工作区
#
# 用法:
#   cd ~/projects/my_app
#   start-workspace              # 使用目录名作为 session 名
#   start-workspace "my-project" # 指定 session 名
#
# 配置: 项目根目录的 agent-config.json
#
# 布局:
# ┌──────────────┬──────────────────────────────┐
# │    yazi      │          Claude              │
# │   (左上)     │          (右上)              │
# ├──────────────┼──────────────┬───────────────┤
# │   lazygit    │   backend    │   frontend    │
# │   (左下)     │   (右下左)   │   (右下右)    │
# └──────────────┴──────────────┴───────────────┘

set -euo pipefail

# ═══════════════════════════════════════════════════════════════
# 默认配置
# ═══════════════════════════════════════════════════════════════

PROJECT_ROOT="$(pwd)"
PROJECT_NAME="$(basename "$PROJECT_ROOT")"
SESSION_NAME="${1:-$PROJECT_NAME}"

# 默认值 (可被 agent-config.json 覆盖)
FRONTEND_DIR="frontend"
FRONTEND_PORT=3000
FRONTEND_CMD=""
BACKEND_DIR="backend"
BACKEND_PORT=8000
BACKEND_CMD=""
BROWSER="chrome"
BROWSER_URL=""
AUTO_OPEN_BROWSER=true

# ═══════════════════════════════════════════════════════════════
# 加载配置
# ═══════════════════════════════════════════════════════════════

CONFIG_FILE="$PROJECT_ROOT/agent-config.json"

if [[ -f "$CONFIG_FILE" ]]; then
    echo -e "\033[1;34m📋 加载配置: $CONFIG_FILE\033[0m"

    # 使用 jq 解析 JSON 配置
    if command -v jq &>/dev/null; then
        FRONTEND_DIR=$(jq -r '.frontend.dir // "frontend"' "$CONFIG_FILE")
        FRONTEND_PORT=$(jq -r '.frontend.port // 3000' "$CONFIG_FILE")
        FRONTEND_CMD=$(jq -r '.frontend.cmd // ""' "$CONFIG_FILE")
        BACKEND_DIR=$(jq -r '.backend.dir // "backend"' "$CONFIG_FILE")
        BACKEND_PORT=$(jq -r '.backend.port // 8000' "$CONFIG_FILE")
        BACKEND_CMD=$(jq -r '.backend.cmd // ""' "$CONFIG_FILE")
        BROWSER=$(jq -r '.browser.type // "chrome"' "$CONFIG_FILE")
        BROWSER_URL=$(jq -r '.browser.url // ""' "$CONFIG_FILE")
        AUTO_OPEN_BROWSER=$(jq -r '.browser.auto_open // true' "$CONFIG_FILE")
    else
        echo -e "\033[1;33m⚠️  jq 未安装，使用默认配置\033[0m"
    fi
else
    echo -e "\033[1;33m⚠️  未找到 agent-config.json，使用默认配置\033[0m"
fi

# ═══════════════════════════════════════════════════════════════
# 检查是否已存在
# ═══════════════════════════════════════════════════════════════

if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo -e "\033[1;33m⚠️  Session '$SESSION_NAME' 已存在，切换到该 session\033[0m"
    tmux switch-client -t "$SESSION_NAME" 2>/dev/null || tmux attach-session -t "$SESSION_NAME"
    exit 0
fi

# ═══════════════════════════════════════════════════════════════
# 创建 tmux session 和布局
# ═══════════════════════════════════════════════════════════════

echo -e "\033[1;32m🚀 创建工作区: $SESSION_NAME\033[0m"
echo -e "\033[1;34m📁 项目目录: $PROJECT_ROOT\033[0m"

# 创建新 session，起始目录为项目根目录
tmux new-session -d -s "$SESSION_NAME" -c "$PROJECT_ROOT"

# 重命名默认窗口
tmux rename-window -t "$SESSION_NAME:0" "main"

# ═══════════════════════════════════════════════════════════════
# 创建布局:
# ┌──────────────┬──────────────────────────────┐
# │    yazi      │          Claude              │
# │   (pane 0)   │          (pane 1)            │
# ├──────────────┼──────────────┬───────────────┤
# │   lazygit    │   backend    │   frontend    │
# │   (pane 2)   │   (pane 3)   │   (pane 4)    │
# └──────────────┴──────────────┴───────────────┘
# ═══════════════════════════════════════════════════════════════

# 步骤1: 水平分割 (左右)
tmux split-window -h -p 60 -t "$SESSION_NAME:main" -c "$PROJECT_ROOT"
# pane 0 = 左, pane 1 = 右

# 步骤2: 左边垂直分割 (上下)
tmux split-window -v -p 50 -t "$SESSION_NAME:main.0" -c "$PROJECT_ROOT"
# pane 0 = 左上, pane 1 = 右, pane 2 = 左下

# 步骤3: 右边垂直分割 (Claude 上, servers 下)
tmux split-window -v -p 40 -t "$SESSION_NAME:main.1" -c "$PROJECT_ROOT"
# pane 0 = 左上(yazi), pane 1 = 右上(claude), pane 2 = 左下(lazygit), pane 3 = 右下

# 步骤4: 右下水平分割 (backend 左, frontend 右)
tmux split-window -h -p 50 -t "$SESSION_NAME:main.3" -c "$PROJECT_ROOT"
# pane 0 = 左上(yazi), pane 1 = 右上(claude), pane 2 = 左下(lazygit)
# pane 3 = 右下左(backend), pane 4 = 右下右(frontend)

# ═══════════════════════════════════════════════════════════════
# 启动各个程序
# ═══════════════════════════════════════════════════════════════

# 左上: yazi
tmux send-keys -t "$SESSION_NAME:main.0" "yazi" Enter

# 左下: lazygit
tmux send-keys -t "$SESSION_NAME:main.2" "lazygit" Enter

# 右上: Claude
tmux send-keys -t "$SESSION_NAME:main.1" "claude" Enter

# 右下左: backend server
if [[ -n "$BACKEND_CMD" ]]; then
    BACKEND_WORK_DIR="$PROJECT_ROOT/$BACKEND_DIR"
    if [[ -d "$BACKEND_WORK_DIR" ]]; then
        CMD="${BACKEND_CMD//\$PORT/$BACKEND_PORT}"
        tmux send-keys -t "$SESSION_NAME:main.3" "cd '$BACKEND_WORK_DIR' && $CMD" Enter
    else
        tmux send-keys -t "$SESSION_NAME:main.3" "echo 'Backend dir not found: $BACKEND_WORK_DIR'" Enter
    fi
fi

# 右下右: frontend server
if [[ -n "$FRONTEND_CMD" ]]; then
    FRONTEND_WORK_DIR="$PROJECT_ROOT/$FRONTEND_DIR"
    if [[ -d "$FRONTEND_WORK_DIR" ]]; then
        CMD="${FRONTEND_CMD//\$PORT/$FRONTEND_PORT}"
        tmux send-keys -t "$SESSION_NAME:main.4" "cd '$FRONTEND_WORK_DIR' && $CMD" Enter
    else
        tmux send-keys -t "$SESSION_NAME:main.4" "echo 'Frontend dir not found: $FRONTEND_WORK_DIR'" Enter
    fi
fi

# ═══════════════════════════════════════════════════════════════
# 打开浏览器
# ═══════════════════════════════════════════════════════════════

if [[ "$AUTO_OPEN_BROWSER" == "true" && -n "$BROWSER_URL" ]]; then
    (
        sleep 3
        URL="${BROWSER_URL//\$FRONTEND_PORT/$FRONTEND_PORT}"
        URL="${URL//\$BACKEND_PORT/$BACKEND_PORT}"
        case "$BROWSER" in
            chrome|"Google Chrome")
                osascript -e "tell application \"Google Chrome\" to open location \"$URL\"" 2>/dev/null || true
                ;;
            arc|Arc)
                osascript -e "tell application \"Arc\" to open location \"$URL\"" 2>/dev/null || true
                ;;
            safari|Safari)
                osascript -e "tell application \"Safari\" to open location \"$URL\"" 2>/dev/null || true
                ;;
            *)
                open "$URL" 2>/dev/null || true
                ;;
        esac
        echo -e "\033[1;32m🌐 已打开浏览器: $URL\033[0m"
    ) &
fi

# ═══════════════════════════════════════════════════════════════
# 焦点设置并切换到 session
# ═══════════════════════════════════════════════════════════════

# 焦点到 Claude pane
tmux select-pane -t "$SESSION_NAME:main.1"

# 切换到新 session
if [[ -n "${TMUX:-}" ]]; then
    tmux switch-client -t "$SESSION_NAME"
else
    tmux attach-session -t "$SESSION_NAME"
fi

echo -e "\033[1;32m✅ 工作区已创建: $SESSION_NAME\033[0m"
